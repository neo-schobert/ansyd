import pandas as pd
import re
from pathlib import Path


BASE_DIR = Path(__file__).resolve().parent
EXPLOITDB_DIR = BASE_DIR / "exploitdb"
CSV_PATH = EXPLOITDB_DIR / "files_exploits.csv"

def find_cve_exploit_db(cve_list):
    if not CSV_PATH.exists():
        raise FileNotFoundError(f"ExploitDB CSV missing: {CSV_PATH}")

    data = pd.read_csv(CSV_PATH, usecols=["file", "codes"])

    arr_codes = data["codes"].to_numpy()
    processed_names = [
        [part for part in str(element).split(";") if part.startswith("CVE")]
        for element in arr_codes
    ]
    paths_cves = data["file"].to_numpy()

    cve_exploit_db_paths = {}

    for i, cves in enumerate(processed_names):
        if not cves:
            continue

        for cve in cve_list:
            if cve in cves:
                exploit_path = EXPLOITDB_DIR / paths_cves[i]
                if exploit_path.exists():
                    cve_exploit_db_paths[cve] = exploit_path.read_text(
                        errors="ignore"
                    )

    return cve_exploit_db_paths


# print(find_cve_exploit_db(['CVE-2018-19371', 'CVE-2007-6271']))
